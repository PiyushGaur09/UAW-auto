workflows:
  ios-manual-sign:
    name: iOS Manual Code Signing Workflow

    environment:
      node: 18.16.0                 # üëà  use RN‚Äësupported Node
      xcode: latest
      vars:
        APP_PROFILE_PATH: "ios/Uaw_Auto.mobileprovision"
        P12_CERT_PATH:    "ios/uaw_certificate.p12"
        CERTIFICATE_PASSWORD: LWXAxSMY
        EXPORT_OPTIONS_PLIST: "ios/exportOptions.plist"
        BUNDLE_ID: "com.uawauto.uaw"

    scripts:
      # 1Ô∏è‚É£  JS deps first ‚Äî generates node_modules/react-native/‚Ä¶
      - name: Install JS dependencies
        script: |
          npm ci

      # 2Ô∏è‚É£  iOS pods next ‚Äî now Podfile can resolve RN scripts
      - name: Install CocoaPods dependencies
        script: |
          cd ios
          pod install --repo-update

      # 3Ô∏è‚É£  Certificate ‚Üí keychain
      - name: Install certificate
        script: |
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import "$P12_CERT_PATH" -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign

      # 4Ô∏è‚É£  Provisioning profile ‚Üí Library/MobileDevice
      - name: Install provisioning profile
        script: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PROFILE_UUID=$(grep -ao '<UUID>.*</UUID>' "$APP_PROFILE_PATH" | sed -E 's:<(/)?UUID>::g')
          echo "Using profile UUID: $PROFILE_UUID"
          cp "$APP_PROFILE_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID".mobileprovision

      # 5Ô∏è‚É£  Patch pbxproj for manual signing
      - name: Apply manual signing to Xcode project
        script: |
          xcode-project use-profiles

      # 6Ô∏è‚É£  Build archive (.xcarchive)
      - name: Build iOS archive
        script: |
          xcodebuild -workspace ios/UAWauto.xcworkspace \
            -scheme UAWauto \
            -archivePath "$CM_BUILD_DIR/UAWauto.xcarchive" \
            archive \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
            OTHER_CODE_SIGN_FLAGS="--keychain build.keychain"

      # 7Ô∏è‚É£  Export signed .ipa
      - name: Export IPA
        script: |
          xcodebuild -exportArchive \
            -archivePath "$CM_BUILD_DIR/UAWauto.xcarchive" \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" \
            -exportPath "$CM_BUILD_DIR/build/ios"
